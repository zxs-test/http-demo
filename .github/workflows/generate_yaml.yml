name: Generate Component Versions YAML

on:
  issues:
    types: [opened, edited]

jobs:
  generate-yaml:
    if: contains(github.event.issue.labels.*.name, 'component-versions')
    runs-on: ubuntu-latest
    outputs:
      artifact_url: ${{ steps.upload-yaml.outputs.artifact-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate YAML from issue
      id: generate_yaml
      run: |
        # ä»issue bodyä¸­æå–æ•°æ®
        ISSUE_BODY="${{ github.event.issue.body }}"
        
        # è§£æè¡¨å•æ•°æ®ï¼ˆè¿™é‡Œéœ€è¦æ ¹æ®å®é™…è¡¨å•ç»“æ„è¿›è¡Œè°ƒæ•´ï¼‰
        HELM_VERSION=$(echo "$ISSUE_BODY" | grep -oP '(?<=Kubernetes Helm Version:).*' | xargs)
        ETCD_VERSION=$(echo "$ISSUE_BODY" | grep -oP '(?<=ETCD Version:).*' | xargs)
        # è§£æå…¶ä»–å­—æ®µ...
        
        # åˆ›å»ºYAMLå†…å®¹
        cat > component_versions.yaml << EOF
        kubernetes:
          helm_version: ${HELM_VERSION}
        etcd:
          etcd_version: ${ETCD_VERSION}
        image_registry:
          keepalived_version: 2.0.20
          harbor_version: v2.6.3
          dockercompose_version: v2.12.2
          docker_registry_version: 2.8.3
        cri:
          container_manager: docker
          sandbox_image:
            tag: "3.6"
          crictl_version: v1.23.0
          docker_version: 20.10.18
          cridockerd_version: v0.3.10
          containerd_version: v1.6.8
          runc_version: v1.1.4
        cni:
          multus:
            image:
              tag: v3.9.3
          calico_version: v3.24.5
          cilium_version: 1.12.6
          kubeovn_version: 1.10.0
          hybridnet_version: 0.6.8
        storage_class:
          local:
            provisioner_image:
              tag: 3.3.0
            linux_utils_image:
              tag: 3.3.0
          nfs_provisioner_version: 4.0.2
        dns:
          dns_image:
            tag: v1.8.6
          dns_cache_image:
            tag: 1.21.1
        EOF

        echo "YAML file generated successfully"

    - name: Upload YAML file
      id: upload-yaml
      uses: actions/upload-artifact@v4
      with:
        name: component-versions-${{ github.event.issue.number }}
        path: component_versions.yaml
        retention-days: 7

    - name: Get artifact URL
      id: artifact-info
      run: |
        # æ„é€ artifactä¸‹è½½é¡µé¢URL
        ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "artifact-url=${ARTIFACT_URL}" >> $GITHUB_OUTPUT

  comment-on-issue:
    if: contains(github.event.issue.labels.*.name, 'component-versions')
    needs: [generate-yaml]
    runs-on: ubuntu-latest
    steps:
      - name: Add comment with artifact URL to issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ‰ æ‚¨çš„ç»„ä»¶ç‰ˆæœ¬YAMLæ–‡ä»¶å·²ç”Ÿæˆï¼

            ğŸ“¦ ç”Ÿæˆçš„YAMLæ–‡ä»¶å·²ä½œä¸ºå·¥ä»¶ä¸Šä¼ ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥ä¸‹è½½ï¼š
            ${{ needs.generate-yaml.outputs.artifact_url }}

            âš ï¸ æ³¨æ„ï¼šå·¥ä»¶å°†åœ¨7å¤©åè‡ªåŠ¨åˆ é™¤ï¼Œè¯·åŠæ—¶ä¸‹è½½ã€‚

            ---
            *è‡ªåŠ¨ç”Ÿæˆäº ${{ github.event.issue.updated_at }}*

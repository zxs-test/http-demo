name: Generate Component Versions YAML

on:
  issues:
    types: [opened, edited]

jobs:
  generate-yaml:
    if: contains(github.event.issue.labels.*.name, 'component-versions')
    runs-on: ubuntu-latest
    outputs:
      artifact_url: ${{ steps.upload-yaml.outputs.artifact-url }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate YAML from issue
      id: generate_yaml
      run: |
        # 从issue body中提取数据
        ISSUE_BODY="${{ github.event.issue.body }}"
        
        # 解析表单数据（这里需要根据实际表单结构进行调整）
        HELM_VERSION=$(echo "$ISSUE_BODY" | grep -oP '(?<=Kubernetes Helm Version:).*' | xargs)
        ETCD_VERSION=$(echo "$ISSUE_BODY" | grep -oP '(?<=ETCD Version:).*' | xargs)
        # 解析其他字段...
        
        # 创建YAML内容
        cat > component_versions.yaml << EOF
        kubernetes:
          helm_version: ${HELM_VERSION}
        etcd:
          etcd_version: ${ETCD_VERSION}
        image_registry:
          keepalived_version: 2.0.20
          harbor_version: v2.6.3
          dockercompose_version: v2.12.2
          docker_registry_version: 2.8.3
        cri:
          container_manager: docker
          sandbox_image:
            tag: "3.6"
          crictl_version: v1.23.0
          docker_version: 20.10.18
          cridockerd_version: v0.3.10
          containerd_version: v1.6.8
          runc_version: v1.1.4
        cni:
          multus:
            image:
              tag: v3.9.3
          calico_version: v3.24.5
          cilium_version: 1.12.6
          kubeovn_version: 1.10.0
          hybridnet_version: 0.6.8
        storage_class:
          local:
            provisioner_image:
              tag: 3.3.0
            linux_utils_image:
              tag: 3.3.0
          nfs_provisioner_version: 4.0.2
        dns:
          dns_image:
            tag: v1.8.6
          dns_cache_image:
            tag: 1.21.1
        EOF

        echo "YAML file generated successfully"

    - name: Upload YAML file
      id: upload-yaml
      uses: actions/upload-artifact@v4
      with:
        name: component-versions-${{ github.event.issue.number }}
        path: component_versions.yaml
        retention-days: 7

    - name: Get artifact URL
      id: artifact-info
      run: |
        # 构造artifact下载页面URL
        ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "artifact-url=${ARTIFACT_URL}" >> $GITHUB_OUTPUT

  comment-on-issue:
    if: contains(github.event.issue.labels.*.name, 'component-versions')
    needs: [generate-yaml]
    runs-on: ubuntu-latest
    steps:
      - name: Add comment with artifact URL to issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: "create-comment"
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            🎉 您的组件版本YAML文件已生成！

            📦 生成的YAML文件已作为工件上传，您可以通过以下链接下载：
            ${{ needs.generate-yaml.outputs.artifact_url }}

            ⚠️ 注意：工件将在7天后自动删除，请及时下载。

            ---
            *自动生成于 ${{ github.event.issue.updated_at }}*
